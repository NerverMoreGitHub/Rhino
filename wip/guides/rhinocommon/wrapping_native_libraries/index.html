<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Wrapping Native Libraries</title>
  <meta name="description" content="Wrapping Native Libraries">

  <!-- OpenGraph for Facebook, Twitter, Slack unfurling -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/guides/rhinocommon/wrapping_native_libraries/" />
  <meta property="og:title" content="Wrapping Native Libraries" />
  <meta property="og:description" content="This guide demonstrates how to wrap a C/C++ library in order to call into it from .NET." />
  <meta property=”og:site_name” content="developer.rhino3d.com"/>
  <meta property=”og:image” content="/wip/images/rhinodev_logo_unfurl.png"/>

  <!-- twitter card tags additive with the og: tags -->
  <meta name="twitter:domain" value="developer.rhino3d.com" />
  <meta name="twitter:title" value="Wrapping Native Libraries" />
  <meta name="twitter:description" value="This guide demonstrates how to wrap a C/C++ library in order to call into it from .NET." />
  
    
      <meta name="twitter:image" content="/wip/images/rhinodev_logo_unfurl.png" />
    
  
  <meta name="twitter:url" value="http://developer.rhino3d.com" />
  
  <meta name="twitter:label1" value="Platform(s)" />
  <meta name="twitter:data1" value="Windows, Mac" />
  
  
  <meta name="twitter:label2" value="Language(s)" />
  <meta name="twitter:data2" value="C#" />
  

  <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/styles/github.min.css">
  <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/languages/vbnet.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <!-- Check the version banner for broken links and remove the link if found -->
  <!-- <script type="text/javascript" src="/script/banner_sanity.js"></script> -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script>
  $.ready(function()
  {
  	var splitPath = window.location.pathname.split("/");
  	var nonWipURL = "/" + splitPath.splice(2,splitPath.length-2).join("/");

  	$.get(nonWipURL).fail(function ()
  	{
      console.log("stripping link");
      var $aTag = $("div.version-banner > a");
  		$aTag.remove();
  	});
  });
  </script>

  <!-- Overridden theme -->
  <link rel="stylesheet" href="/wip/css/main.css">

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
  <!-- Bootstrap override -->
  <link rel="stylesheet" href="/wip/css/bootstrap-override.css">

  <link rel="canonical" href="http://developer.rhino3d.com/wip/guides/rhinocommon/wrapping_native_libraries/">
  <link rel="alternate" type="application/rss+xml" title="Rhino Developer Docs" href="http://developer.rhino3d.com/wip/feed.xml" />

  <link rel="shortcut icon" href="http://developer.rhino3d.com/favicon.ico?v=2" />
  <!-- Saving bookmarks to mobile devices -->
  <!-- For non-Retina (@1× display) iPhone, iPod Touch, and Android 2.1+ devices: -->
  <link rel="apple-touch-icon-precomposed" href="/wip/images/apple-touch-icon-precomposed.png"><!-- 57×57px -->
  <!-- For the iPad mini and the first- and second-generation iPad (@1× display) on iOS ≤ 6: -->
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/wip/images/apple-touch-icon-72x72-precomposed.png">
  <!-- For the iPad mini and the first- and second-generation iPad (@1× display) on iOS ≥ 7: -->
  <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/wip/images/apple-touch-icon-76x76-precomposed.png">
  <!-- For iPhone with @2× display running iOS ≤ 6: -->
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/wip/images/apple-touch-icon-114x114-precomposed.png">
  <!-- For iPhone with @2× display running iOS ≥ 7: -->
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/wip/images/apple-touch-icon-120x120-precomposed.png">
  <!-- For iPad with @2× display running iOS ≤ 6: -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/wip/images/apple-touch-icon-144x144-precomposed.png">
  <!-- For iPad with @2× display running iOS ≥ 7: -->
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/wip/images/apple-touch-icon-152x152-precomposed.png">
  <!-- For iPhone 6 Plus with @3× display: -->
  <link rel="apple-touch-icon-precomposed" sizes="180x180" href="/wip/images/apple-touch-icon-180x180-precomposed.png">
  <!-- For Chrome for Android: -->
  <link rel="icon" sizes="192x192" href="images/touch-icon-192x192.png">

  <!-- Diable crawling until this version is the stable version -->
  <meta name="robots" content="noindex" />
</head>


  <body>

    <!-- Google Tag Manager **This belongs right after the <body> tag**-->
    <noscript>
        <iframe src="//www.googletagmanager.com/ns.html?id=GTM-MWMDKN"
        height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <script>
        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-MWMDKN');
    </script>
    <!-- End Google Tag Manager -->


    
<div class="version-banner">
    Hey, you're viewing the <strong>wip</strong> version of this page!
    <a href="/guides/rhinocommon/wrapping_native_libraries/">View the current version instead.</a>
</div>



    <div class="container">

      <header class="site-header">


    <a class="site-title" href="/wip/"><img src="/wip/images/rhinodevlogo148x128.png" alt="Rhino Developer Docs" height="48" width="56"></a><a class="site-title" href="/wip/">Rhino Developer Docs</a>

    <nav class="site-nav">
      <img class="menu-icon" src="/wip/images/gi.svg">
      
      <div class="trigger">
      	<!--<a class="page-link" href="/wip/">Welcome</a>-->
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
        
          
            
              
                <a class="page-link" href="/wip/guides/">Guides</a>
              
            
          
        
          
            
              
                <a class="page-link" href="/wip/api/">API</a>
              
            
          
        
          
            
              
                <a class="page-link" href="/wip/samples/">Samples</a>
              
            
          
        
          
            
          
        
        <a class="page-link" href="http://discourse.mcneel.com/c/rhino-developer">Forums</a>
        <!-- Google Search Engine -->
        <!-- TODO Move to this site back into the Mcneel search, or use a simple site only search for results -->
        <div id="sitesearch">
            <!-- Google CSE Search Box Begins  -->
            <!-- Use of this code assumes agreement with the Google Custom Search Terms of Service. -->
            <!-- The terms of service are available at https://www.google.com/cse/docs/tos.html -->
            <form id="cref" action="/wip/search-results.html">
                <input type="hidden" name="cref" value="007988927381198593803:mcq6pshqsn8" />
                <input id="searchtext" type="text" name="q" size="24" value="" placeholder="search" />
                <input class="searchBox" type="submit" name="sa" size="2" value=" " />
            </form>
        <!-- Google CSE Search Box Ends -->
        </div>
        <!--End of Google Search Engine -->
      </div>
    </nav>

</header>


      <div class="page-content">
        <!--div class="wrapper"-->
          <div class="container-fluid">

<div class="row-fluid">
    <!--Nav Bar -->
    <nav class="col-xs-0 col-md-3 bs-docs-sidebar">
        <ul id="sidebar" class="nav nav-stacked fixed">

          <li>
            <a href="/wip/guides/">Guides</a>

            <ul class="nav nav-stacked">

              <li>

                
                  <a href="/wip/guides/#rhinocommon">RhinoCommon</a>
                
                <ul class="nav nav-stacked">

                  <!-- Find the h1 handle for title -->
                  
                  
                  
                  
                  
                  
                  
                  <li>
                    <a href="#wrapping-native-libraries">Wrapping Native Libraries</a>

                    <ul class="nav nav-stacked">

                      <!-- Find the h2 group and any h3 subgroups -->
                      

                      
                        
                        
                        
                        
                        
                        <li>
                          <a href="#overview">Overview</a>

                          
                            <ul class="nav nav-stacked">
                              

                              
                                
                                
                                
                                
                                
                                <li>
                                    <a href="#prerequisites">Prerequisites</a>
                                </li>
                              

                            </ul>
                          

                        </li>
                      
                        
                        
                        
                        
                        
                        <li>
                          <a href="#samplelibrary">SampleLibrary</a>

                          
                            <ul class="nav nav-stacked">
                              

                              
                                
                                
                                
                                
                                
                                <li>
                                    <a href="#windows">Windows</a>
                                </li>
                              
                                
                                
                                
                                
                                
                                <li>
                                    <a href="#mac">Mac</a>
                                </li>
                              

                            </ul>
                          

                        </li>
                      
                        
                        
                        
                        
                        
                        <li>
                          <a href="#samplenativelibrary">SampleNativeLibrary</a>

                          
                            <ul class="nav nav-stacked">
                              

                              
                                
                                
                                
                                
                                
                                <li>
                                    <a href="#windows-1">Windows</a>
                                </li>
                              
                                
                                
                                
                                
                                
                                <li>
                                    <a href="#mac-1">Mac</a>
                                </li>
                              

                            </ul>
                          

                        </li>
                      
                        
                        
                        
                        
                        
                        <li>
                          <a href="#next-steps">Next Steps</a>

                          

                        </li>
                      
                        
                        
                        
                        
                        
                        <li>
                          <a href="#related-topics">Related topics</a>

                          

                        </li>
                      

                    </ul>

                  </li>

                </ul>

              </li>

            </ul>

          </li>

        </ul>
    </nav>
    <!--Main Content -->
    <div class="col-xs-12 col-md-9">
      <!--<div class="post">-->

        <article class="post-content">
          <h1 id="wrapping-native-libraries">Wrapping Native Libraries</h1>

<p>This guide demonstrates how to wrap a C/C++ library in order to call into it from .NET.</p>

<h2 id="overview">Overview</h2>

<p>We present a sample solution that uses Platform Invoke (PInvoke), which allows .NET code to call functions that are implemented in a C/C++ DLL (Windows) or dylib (Mac OS X).  It is important to understand that the main utility of this advanced approach is in the ability to call the same C/C++ code on both platforms from .NET.</p>

<p>First, we will build a simple C/C++ library that adds two numbers together.  After that, we will examine the wrapping .NET code required to call into our library from a RhinoCommon plugin on both Windows and Mac.</p>

<h3 id="prerequisites">Prerequisites</h3>

<p>This guide does not presume you are a C/C++ or .NET expert, but assumes you have a functional working knowledge of both.  This is an advanced guide; that said, the intent of this guide is to illustrate basic considerations of wrapping a C/C++ library and the logistical issues calling it from a RhinoCommon plugin on both Windows and Mac.</p>

<p>We will be analyzing a sample solution called <strong><a href="https://github.com/dalefugier/SampleNativeLibrary">SampleNativeLibrary</a></strong>.  Please clone or download this repository.  <strong>SampleNativeLibrary</strong> builds against the RhinoWIP (on Windows) and Rhino 5 for Mac (on OS X).  (On Windows, it is possible to use Rhino 5, but you will have to change the RhinoCommon references).</p>

<p>It is presumed you already have <em>all</em> the necessary tools installed and are ready to go.  If you are not there yet, see both <a href="/wip/guides/rhinocommon/installing_tools_windows">Installing Tools (Windows)</a> and <a href="/wip/guides/rhinocommon/installing_tools_mac">Installing Tools (Mac)</a>.  It is also helpful to have read and understood <a href="/wip/guides/rhinocommon/your_first_plugin_crossplatform">Your First Plugin (Cross-Platform)</a>.</p>

<div class="bs-callout bs-callout-danger">
  <h4>WARNING</h4>
  <p>Other methods to create a .NET binding to a C# library exist. A notorious one is based on the compilation of the C++ library with the C++/CLI compiler. To keep things compatible with the Apple Mac OS X, and because the IJW (it just works) technology sometimes does not, we suggest the use of PInvoke.</p>
</div>

<h2 id="samplelibrary">SampleLibrary</h2>

<p>Let’s begin by taking a look at an absurdly simple C/C++ “library” - SampleLibrary - that does one thing: add two numbers together.  We’ll start on Windows, but it really doesn’t matter if you start on a OS X, nearly everything that follows applies on each platform…</p>

<h3 id="windows">Windows</h3>

<ol>
  <li>Open <strong>SampleNativeLibrary.sln</strong> in <strong>Visual Studio</strong>.</li>
  <li>In the Solution Explorer, you will notice there are three projects…two C# (.csproj) projects and one C++ project.  Expand the <strong>SampleLibrary</strong> C++ project…
<img src="/wip/images/wrapping_native_libraries_02.png" alt="SampleNativeLibrary" /></li>
  <li>The <strong>SampleLibrary</strong> (.vcxproj) is just a boilerplate C++ project (created using the regular Shared MFC C++ project wizard) that was created by Visual Studio.  <em>There is nothing fancy going on here at all; much of the code is not even relevant to this guide</em>.</li>
  <li>
    <p>Open the <strong>SampleLibrary.cpp</strong> file and take a look.  Nearly all of the code in this file is auto-generated boilerplate.  The only important section to pay attention to is:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> SAMPLELIBRARY_C_FUNCTION
 double Add(int a, double b)
 {
   return a + b;
 }  
</code></pre>
    </div>

    <p>…even if you are not a C/C++ programmer, this C function should be clear to you.  <code class="highlighter-rouge">Add</code> takes a native <code class="highlighter-rouge">int</code> and a native <code class="highlighter-rouge">double</code>, and returns the sum of the inputs as a native <code class="highlighter-rouge">double</code>.  Take note of the <code class="highlighter-rouge">SAMPLELIBRARY_C_FUNCTION</code> decoration above the implementation…we will talk about that in a moment.</p>
  </li>
  <li>In the <strong>Header Files</strong> filter, find and open the <strong>SampleLibraryInclude.h</strong> header file.  The first thing to note is that there are two well <code class="highlighter-rouge">#defined</code> sections to this header: one that relates to Windows (<code class="highlighter-rouge">#if defined (_WIN32)</code>) and one that relates to Mac (<code class="highlighter-rouge">#if defined(__APPLE__)</code>).  The code in these #defines are basically telling the linker to export functions in a specific way.  The reason they are different on each platform is that Dynamic Link Libraries (DLLs) are implemented differently in Windows and OS X - each platform has a unique way of telling the linker what to do with the library.  How this works is not really important at this juncture, just know that these MACROs tell the linker to export the functions.  More importantly…</li>
  <li>
    <p>Take a look at the function declaration at the bottom of the file:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> SAMPLELIBRARY_C_FUNCTION
 double Add(int a, double b);
</code></pre>
    </div>

    <p>…is decorated with the same <code class="highlighter-rouge">SAMPLELIBRARY_C_FUNCTION</code>.</p>
  </li>
  <li>This is the decoration that tells the linker to make the function available to outside callers.  By decorating with this macro, the linker adds information to the DLL that makes these functions public.  Without this decoration, these functions would not be available outside the the assembly (.dll or .dylib).  By providing this decoration, we are doing the .NET equivalent of making them “public”.</li>
  <li>Do a “sanity check” and <strong>Build</strong> SampleLibrary to make sure that all your tools are working as expected.  SampleLibrary should build without errors as the native <em>SampleLibrary.dll</em> in the project <em>/bin</em> folder.  Ok, now that we know roughly what is in the native SampleLibrary on Windows, let’s take a look at it on Mac OS X…</li>
</ol>

<h3 id="mac">Mac</h3>

<ol>
  <li>Launch <strong>Xcode</strong> and open <strong>SampleLibrary.xcodeproj</strong>.  (Unlike Visual Studio on Windows, on OS X, we cannot do all of our development in a single IDE, but we have to build our native C/C++ <strong>SampleLibrary</strong> using the native Apple Tools - Xcode and xcodebuild).</li>
  <li>In the <strong>Project Navigator</strong>, notice that this project is referencing the <em>exact same source code</em> as its Windows counterpart…
<img src="/wip/images/wrapping_native_libraries_03.png" alt="SampleLibrary on OS X" /></li>
  <li>Instead of building a .dll, on OS X we are building <strong>libSampleLibrary.dylib</strong> which - despite the extension - amounts to exactly the same thing as a dll.  For all intents and purposes, SampleLibrary does exactly the same thing on OS X that it does on Windows and the source is the same.</li>
  <li><strong>Build</strong> SampleLibrary using Xcode to make sure that it builds successfully.</li>
  <li><strong>Quit</strong> Xcode.  On OS X, we are actually going to use command line <code class="highlighter-rouge">xcodebuild</code> from Xamarin Studio to build our native library, but we’ll talk about that below.</li>
</ol>

<p>Now that we have examined the simple native SampleLibrary, let’s turn our attention to the .NET portion of our wrapping code…</p>

<h2 id="samplenativelibrary">SampleNativeLibrary</h2>

<p>SampleNativeLibrary is the .NET project that calls into the SampleLibrary.  On each platform, we are using the exact same wrapping source code, just using cloned .csproj projects on each platform.  (For more information on this cross-platform strategy, see the <a href="/wip/guides/rhinocommon/your_first_plugin_crossplatform">Your First Plugin (Cross-Platform)</a> guide).</p>

<p>Let’s take a look at SampleNativeLibrary on Windows using Visual Studio first…</p>

<h3 id="windows-1">Windows</h3>

<ol>
  <li>If you have not done so already, open the <strong>SampleNativeLibrary.sln</strong> in <strong>Visual Studio</strong>.</li>
  <li>If you have not done so already, build <strong>SampleLibrary</strong>.  Verify that <em>SampleLibrary.dll</em> is present in your <em>/bin</em> folder.</li>
  <li>Now, let’s turn our attention to the <strong>SampleRhino.Win</strong> project.  Make sure that <strong>SampleRhino.Win</strong> is set as the Startup Project and expand it so you can see the source files…
<img src="/wip/images/wrapping_native_libraries_04.png" alt="SampleRhino on Windows" /></li>
  <li>Before we do anything, let’s build and test the plugin.  Build <strong>SampleRhino.Win</strong>.</li>
  <li>Load the <strong>SampleRhino.rhp</strong> in Rhino and run the <strong>SampleRhinoCommand</strong>.  You will be prompted to enter two numbers.  Once you have done that you should see the result in a dialog box…
<img src="/wip/images/wrapping_native_libraries_05.png" alt="SampleRhino plugin test" /></li>
  <li>The “additional” calculation for this command was all performed in the native C/C++ SampleLibrary.dll.  Return to <strong>Visual Studio</strong>.  Let’s take a look at how the <code class="highlighter-rouge">Add</code> function is being called.</li>
  <li>
    <p>Open <strong>SampleRhinoCommand.cs</strong> and find the <code class="highlighter-rouge">RunCommand</code> method.  After prompting the user to enter two numbers, we see the following code</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> var result = RhinoMath.UnsetValue;
 try
 {
   result = UnsafeNativeMethods.Add(first, second);
 }
 catch (Exception ex)
 {
   RhinoApp.WriteLine(ex.Message);        
   return Result.Failure;
 }
</code></pre>
    </div>
  </li>
  <li>The <code class="highlighter-rouge">Add(first, second)</code> method is being called on the <code class="highlighter-rouge">UnsafeNativeMethods</code> class.  Open <strong>UnsafeNativeMethods.cs</strong>.  Let’s go through this class line-by-line.</li>
  <li>The necessary functionality to use PInvoke is contained in the <code class="highlighter-rouge">System.Runtime.InteropServices</code> namespace, specifically the <code class="highlighter-rouge">DllImport</code> function.</li>
  <li>
    <p><strong>UnsafeNativeMethods.cs</strong> contains the class:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> internal static class Import
 {
   public const string lib = "SampleLibrary.dll";
 }
</code></pre>
    </div>

    <p>…which declares a <code class="highlighter-rouge">lib</code> string member.  On Windows, it is necessary to explicitly state the name of the native dll being called (on OS X, a <em>.dll.config</em> file is used to point to a .dylib - see below).</p>
  </li>
  <li>
    <p>The <code class="highlighter-rouge">UnsafeNativeMethods</code> class itself contains a single function…</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> internal static extern double Add(int a, double b);
</code></pre>
    </div>

    <p>…does this look familiar?</p>
  </li>
  <li>
    <p>The <code class="highlighter-rouge">Add</code> function is decorated with an <a href="https://msdn.microsoft.com/en-us/library/z0w1kczw.aspx">Attribute</a>:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> [DllImport(Import.lib, CallingConvention = CallingConvention.Cdecl)]
</code></pre>
    </div>

    <p>…this important bit of metadata tells the runtime to look in the native library and call the associated function with a specific language (C) calling convention when the <code class="highlighter-rouge">Add</code> method is called from .NET.  <strong>This is the point at which the link between the managed .NET code and the unmanaged C/C++ code is established.</strong></p>
  </li>
  <li>Since we are bridging the world of managed and unmanaged code, <strong>we need to be very careful about the types of variables we are using</strong>.  To illustrate this point, let’s change the code and see what happens…</li>
  <li>
    <p>In <strong>UnsafeNativeMethods</strong> change the function declaration of <code class="highlighter-rouge">Add</code> to accept <code class="highlighter-rouge">double</code>s (instead of <code class="highlighter-rouge">int</code>s) as the first argument…</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> internal static extern double Add(double a, double b);
</code></pre>
    </div>
  </li>
  <li><strong>Build</strong> the plugin.  No errors or warnings, right?   Now run the plugin and test the <strong>SampleRhinoCommand</strong> with this change.  Try adding 2 + 2.  What happens?  <strong>2 + 2 no longer equals 4</strong>.  That’s bad (hopefully, Rhino did not crash).  The compiler did not detect the error we introduced.  Change the type of argument <code class="highlighter-rouge">a</code> back to an <code class="highlighter-rouge">int</code>, rather than a <code class="highlighter-rouge">double</code> and save the file.</li>
  <li><strong>You must ensure that the function in .NET exactly matches the function declaration in the header file made in the unmanaged code</strong> (in this case, in <em>SampleLibraryInclude.h</em>).  Managing these correspondences is challenging with all but the most trivial libraries.  In <a href="/wip/guides/rhinocommon/using_methodgen">Using methodgen</a>, we will discuss a way of generating these function signatures using a utility program we wrote to maintain RhinoCommon.  Before we do that, let’s turn our attention to…</li>
</ol>

<h3 id="mac-1">Mac</h3>

<ol>
  <li>If you have not done so already, open the <strong>SampleNativeLibrary.sln</strong> in <strong>Xamarin Studio</strong>.</li>
  <li>The native <strong>SampleLibrary</strong> project cannot be built from Xamarin Studio.  As mentioned above, Xamarin Studio is a .NET only IDE; it cannot build C/C++ projects like Visual Studio.  (We will work around this limitation in a moment).</li>
  <li>First, let’s turn our attention to the <strong>SampleRhino.Mac</strong> project.  Make sure that <strong>SampleRhino.Mac</strong> is set as the Startup Project and expand it so you can see the source files…
<img src="/wip/images/wrapping_native_libraries_06.png" alt="SampleRhino on Mac" /></li>
  <li>Just as with <strong>SampleLibrary</strong>, <strong>SampleRhino</strong> is exactly the same source on both platform: the platform-specific <em>.csproj</em> files are referencing exactly the same <em>.cs</em> files.</li>
  <li><strong>Build</strong>, run, and test <strong>SampleRhinoCommand</strong> in Rhino for Mac.  Everything should work as expected.  No surprises here…all the code is the same (if you skipped the <a href="#windows-1">Windows section above</a>, read it now; all of it applies on OS X).</li>
  <li>
    <p>There is one critical difference between how the Windows and OS X wrapping works and it has little to do with code.  As we saw above, <strong>UnsafeNativeMethods.cs</strong> contains the class:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code> internal static class Import
 {
   public const string lib = "SampleLibrary.dll";
 }
</code></pre>
    </div>

    <p>…which declares a <code class="highlighter-rouge">lib</code> string member.  On Windows, it was necessary to explicitly state the name of the native dll being called.  On OS X, this works a little differently.  In order to understand what is different, let’s look at how <strong>SampleLibrary.dll</strong> gets built on OS X…</p>
  </li>
  <li>In the <a href="#mac">SampleLibrary (Mac) section above</a>, we built SampleLibrary using Xcode.  We mentioned in passing that we could build this using <code class="highlighter-rouge">xcodebuild</code> command line from Xamarin Studio.  Let’s take a look.</li>
  <li>In the <strong>Solution Explorer</strong>, <strong>double-click</strong> the name of the <strong>SampleRhino.Mac</strong> project to bring up the <strong>Project Options</strong> dialog.  Navigate to the <strong>Build</strong> &gt; <strong>Custom Commands</strong> section…
<img src="/wip/images/wrapping_native_libraries_07.png" alt="SampleRhino.Mac Project Options" /></li>
  <li>There are 5 <strong>Custom Commands</strong>:
    <ol>
      <li><strong>Before Build</strong>: This before build steps runs a python script called <em>build_native.py</em> that uses <code class="highlighter-rouge">xcodebuild</code> to build the <em>SampleLibrary.xcodeproj</em>, which builds <em>libSampleLibrary.dylib</em>.</li>
      <li>
        <p><strong>After Build 1</strong>: This after build step copies the <em>SampleLibrary.dll.config</em> file from the <em>/SampleLibrary</em> folder to the target folder.  <em>SampleLibrary.dll.config</em> creates a mapping between calls to <em>SampleLibrary.dll</em> and <em>libSampleLibrary.dylib</em>…</p>

        <div class="highlighter-rouge"><pre class="highlight"><code> &lt;configuration&gt;
    &lt;dllmap dll=“SampleLibrary.dll” target="libSampleLibrary.dylib" /&gt;
 &lt;/configuration&gt;
</code></pre>
        </div>

        <p>On OS X, both the <em>.dll.config</em> file and the <em>.dylib</em> must be in the same folder as the calling .NET dll.</p>
      </li>
      <li><strong>After Build 2</strong>: This after build step copies <em>libSampleLibrary.dylib</em> to the same folder as the calling .NET dll.</li>
      <li><strong>After Clean 1</strong>: This after build step deletes the <em>libSampleLibrary.dylib</em> when a clean is performed.</li>
      <li><strong>After Clean 1</strong>: This after build step deletes the <em>SampleLibrary.dll.config</em> when a clean is performed.</li>
    </ol>
  </li>
  <li>When you <strong>Build</strong> and run <strong>SampleRhino.Mac</strong> you can watch the build steps in the <strong>output</strong> (right) side of the <strong>Errors</strong> panel.  You may notice that <em>build_native.py</em> will only build <em>libSampleLibrary.dylib</em> if it does not find a previous version.  You can overwrite this with the <code class="highlighter-rouge">-o   --overwrite</code> command argument if you want to build the native library every time you build the .NET wrapping dll.</li>
</ol>

<hr />

<h2 id="next-steps">Next Steps</h2>

<p>You have seen how a basic C/C++ library can be wrapped and called from .NET in a Rhino Plugin.  You have also seen what can go wrong when a native method’s export declaration is out-of-sync with its .NET counterpart.  <strong>Now what?</strong></p>

<p>Check out the <a href="/wip/guides/rhinocommon/using_methodgen">Using methodgen</a> guide for instructions on programmatically generating UnsafeNativeMethods export declarations.</p>

<hr />

<h2 id="related-topics">Related topics</h2>

<ul>
  <li><a href="https://msdn.microsoft.com/en-us/library/aa288468(VS.71).aspx">Microsoft Platform Invoke Tutorial on MSDN</a></li>
  <li><a href="http://www.mono-project.com/docs/advanced/pinvoke/">Interop with Native Libraries on mono-project.org</a></li>
  <li><a href="https://msdn.microsoft.com/en-us/library/z0w1kczw.aspx">Attributes on MSDN</a></li>
  <li><a href="https://github.com/dalefugier/Moose">Moose sample on GitHub</a></li>
  <li><a href="/wip/guides/rhinocommon/your_first_plugin_crossplatform">Your First Plugin (Cross-Platform)</a></li>
  <li><a href="/wip/guides/rhinocommon/using_methodgen">Using methodgen</a></li>
</ul>

        </article>

      <!--</div>-->

    </div>
</div>
</div>

        <!--/div-->
      </div>

      <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">

      
        <div class="row">
          <div class="col-md-4">
            <p class="text">Author: <a href="mailto:dan@mcneel.com">dan@mcneel.com</a></p>
          </div>
          <div class="col-md-4 text-center">
            <span class="icon  icon--github">
              <svg viewBox="0 0 16 16">
                <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <a href="https://github.com/mcneel/developer-rhino3d-com/blob/wip/_guide_topics/rhinocommon/wrapping_native_libraries.md" target="_blank">Edit page on GitHub</a>
          </div>
            <div class="col-md-4">
              <span class="pull-right">
                <span class="glyphicon glyphicon-cog"></span>&nbsp;<a href="/wip/admin">Admin</a>
              </span>
            </div>
        </div>

        <div class="row text-center">
          © 1997 - 2016 Robert McNeel &amp; Associates
        </div>

      

    </div>

  </div>

  <script>
    if (navigator.appVersion.indexOf("Win")!=-1)
    {
      var body = document.getElementsByTagName("body");
      body[0].style.fontWeight = '400';
    }
  </script>

</footer>

    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

    <!-- MathJax -->
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <script type="text/javascript">
    $('body').scrollspy({
        target: '.bs-docs-sidebar',
        offset: 150 /* fixed header is about 40px high */
    });
    </script>
  </body>

</html>
